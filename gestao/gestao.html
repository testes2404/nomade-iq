<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel de Gestão – Nômade IQ</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase UMD v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #020617; /* bem escuro */
    }

    /* Drag & drop highlight */
    .dropzone-highlight {
      border-color: #6366F1 !important;
      background-color: rgba(99, 102, 241, 0.06) !important;
    }

    /* Rolagem suave para lista longa */
    .thin-scrollbar::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    .thin-scrollbar::-webkit-scrollbar-thumb {
      background-color: rgba(148, 163, 184, 0.8);
      border-radius: 999px;
    }
  </style>
</head>
<body class="min-h-screen text-slate-100 antialiased flex flex-col">

  <!-- ========= HEADER / MENU SUPERIOR ========= -->
  <header class="bg-slate-950/80 backdrop-blur border-b border-slate-800 sticky top-0 z-40">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
      <!-- Logo + título -->
      <div class="flex items-center gap-3">
        <img src="../recursos/logo.png" alt="Logo Nômade IQ" class="h-8 w-auto"
             onerror="this.onerror=null; this.src='../recursos/logo.png';">
        <div class="flex flex-col leading-tight">
          <span class="text-sm uppercase tracking-[0.25em] text-slate-400">Painel</span>
          <span class="text-lg font-semibold text-slate-50">Gestão de Conteúdos</span>
        </div>
      </div>

      <!-- Menu simples (futuro) -->
      <nav class="flex items-center gap-3 text-sm">
        <span class="px-3 py-1 rounded-full bg-slate-900 text-indigo-300 border border-indigo-500/40">
          Master
        </span>
        <a href="../index.html" class="px-3 py-1 rounded-lg border border-slate-700 text-slate-300 hover:bg-slate-800 transition">
          Voltar ao site
        </a>
      </nav>
    </div>
  </header>

  <!-- ========= CONTEÚDO PRINCIPAL ========= -->
  <main class="flex-1">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-10 flex gap-6">
      
      <!-- ========= MENU LATERAL ========= -->
      <aside class="w-56 shrink-0 bg-slate-950/80 border border-slate-800 rounded-2xl p-4 h-max">
        <h2 class="text-xs font-semibold uppercase tracking-wide text-slate-400 mb-3">
          Seções do painel
        </h2>

        <!-- Botão 1 -->
        <button
          id="btn-redacao-principal"
          class="w-full inline-flex items-center justify-between gap-2 rounded-xl bg-slate-900/80 border border-slate-700 px-3 py-2 text-sm text-slate-100 hover:border-indigo-500 hover:bg-slate-900 hover:text-indigo-200 transition"
        >
          <span>Redação página principal</span>
          <span class="inline-flex items-center justify-center h-5 w-5 rounded-full bg-indigo-600/20 text-[10px] text-indigo-300 border border-indigo-500/40">
            TXT
          </span>
        </button>

        <!-- Botão 2 -->
        <button
          id="btn-redacao-comissario"
          class="mt-2 w-full inline-flex items-center justify-between gap-2 rounded-xl bg-slate-900/80 border border-slate-700 px-3 py-2 text-sm text-slate-100 hover:border-indigo-500 hover:bg-slate-900 hover:text-indigo-200 transition"
        >
          <span>Redação de conteúdo comissário</span>
          <span class="inline-flex items-center justify-center h-5 w-5 rounded-full bg-indigo-600/20 text-[10px] text-indigo-300 border border-indigo-500/40">
            ART
          </span>
        </button>
      </aside>

      <!-- ========= ÁREA DE CONTEÚDO ========= -->
      <div class="flex-1">
        <!-- Placeholder padrão (antes de clicar em qualquer coisa) -->
        <div id="view-placeholder" class="h-full min-h-[260px] flex items-center justify-center text-sm text-slate-500 border border-dashed border-slate-800/70 rounded-2xl bg-slate-950/40">
          Selecione uma opção no menu ao lado para gerenciar os conteúdos.
        </div>

        <!-- ================= VIEW 1 – REDAÇÃO PÁGINA PRINCIPAL ================= -->
        <div id="view-redacao-principal" class="space-y-10 hidden mt-0">
          <!-- Título da página -->
          <section>
            <h1 class="text-2xl sm:text-3xl font-bold tracking-tight text-slate-50 mb-2">
              Biblioteca de Textos (.txt)
            </h1>
            <p class="text-sm text-slate-400 max-w-2xl">
              Suba aqui os arquivos <span class="font-semibold text-slate-200">.txt</span> com novidades,
              roteiros ou conteúdos diários da <span class="font-semibold">página principal</span>.
              O último texto enviado sempre aparece em primeiro na lista abaixo.
            </p>
          </section>

          <div class="grid lg:grid-cols-[minmax(0,1.2fr)_minmax(0,1fr)] gap-8 items-start">
            <!-- ========= COLUNA ESQUERDA: FORM NOVO TEXTO ========= -->
            <section class="bg-slate-950/70 border border-slate-800/70 rounded-2xl p-6 sm:p-7 shadow-xl shadow-slate-950/40">
              <h2 class="text-lg font-semibold text-slate-50 mb-4 flex items-center gap-2">
                <span class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-indigo-600/20 text-indigo-300 border border-indigo-500/40 text-sm">
                  1
                </span>
                Novo texto .txt
              </h2>

              <form id="txt-form" class="space-y-6">
                <!-- TÍTULO -->
                <div>
                  <label for="txt-title" class="block text-sm font-medium text-slate-200 mb-1">
                    Título do texto
                  </label>
                  <input
                    type="text"
                    id="txt-title"
                    class="mt-1 block w-full rounded-lg border border-slate-700 bg-slate-900/60 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/60 outline-none"
                    placeholder="Ex.: Novidade do dia – Custo de vida em Lisboa"
                    required
                  >
                </div>

                <!-- DROPZONE / INPUT DE ARQUIVO -->
                <div>
                  <label class="block text-sm font-medium text-slate-200 mb-1">
                    Arquivo .txt
                  </label>

                  <div
                    id="dropzone"
                    class="mt-1 flex flex-col items-center justify-center rounded-xl border border-dashed border-slate-700 bg-slate-900/40 px-4 py-6 text-center cursor-pointer transition"
                  >
                    <input
                      type="file"
                      id="txt-file"
                      accept=".txt"
                      class="hidden"
                    >
                    <div class="flex flex-col items-center gap-2">
                      <div class="flex h-10 w-10 items-center justify-center rounded-full bg-slate-800 text-indigo-300">
                        <!-- ícone -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6"
                                d="M9 17v-3m3 3V7m3 10v-5M4 4h16v16H4z"/>
                        </svg>
                      </div>
                      <p class="text-sm text-slate-200">
                        Arraste e solte um arquivo <span class="font-semibold">.txt</span> aqui
                      </p>
                      <p class="text-xs text-slate-500">
                        ou clique para selecionar no seu computador
                      </p>
                      <p id="file-name" class="text-xs text-indigo-300 mt-1 hidden"></p>
                    </div>
                  </div>
                </div>

                <!-- BOTÃO & STATUS -->
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                  <button
                    type="submit"
                    id="btn-upload"
                    class="inline-flex items-center justify-center gap-2 rounded-lg bg-indigo-600 px-4 py-2.5 text-sm font-semibold text-white shadow-lg shadow-indigo-900/40 hover:bg-indigo-500 disabled:opacity-60 disabled:cursor-not-allowed transition"
                  >
                    <span id="btn-upload-label">Salvar texto</span>
                    <svg id="btn-upload-spinner" class="h-4 w-4 animate-spin hidden" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3"></circle>
                      <path class="opacity-75" fill="currentColor"
                            d="M4 12a8 8 0 018-8v3a5 5 0 00-5 5H4z"></path>
                    </svg>
                  </button>

                  <p id="upload-status" class="text-xs text-slate-400 sm:text-right min-h-[1.25rem]">
                    <!-- status aqui -->
                  </p>
                </div>
              </form>
            </section>

            <!-- ========= COLUNA DIREITA: LISTA ========= -->
            <section class="bg-slate-950/60 border border-slate-800/70 rounded-2xl p-5 sm:p-6 shadow-xl shadow-slate-950/40">
              <div class="flex items-center justify-between gap-2 mb-4">
                <div>
                  <h2 class="text-base font-semibold text-slate-50">
                    Últimos textos enviados
                  </h2>
                  <p class="text-xs text-slate-500">
                    Sempre do mais recente para o mais antigo.
                  </p>
                </div>
                <button
                  id="btn-reload"
                  class="inline-flex items-center justify-center rounded-full border border-slate-700 bg-slate-900/70 p-2 text-slate-300 hover:bg-slate-800 hover:text-white text-xs transition"
                  title="Recarregar lista"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6"
                          d="M4 4v6h6M20 20v-6h-6M5 19A9 9 0 0119 5M19 19A9 9 0 015 5"/>
                  </svg>
                </button>
              </div>

              <div id="txt-list" class="thin-scrollbar max-h-[360px] overflow-y-auto space-y-3 text-sm">
                <p class="text-xs text-slate-500" id="txt-list-empty">
                  Nenhum texto enviado ainda. Salve o primeiro .txt ao lado.
                </p>
              </div>
            </section>
          </div>
        </div>

        <!-- ================= VIEW 2 – REDAÇÃO CONTEÚDO COMISSÁRIO ================= -->
        <div id="view-redacao-comissario" class="space-y-10 hidden mt-0">
          <!-- Título da página -->
          <section>
            <h1 class="text-2xl sm:text-3xl font-bold tracking-tight text-slate-50 mb-2">
              Conteúdos – Trilha do Comissário
            </h1>
            <p class="text-sm text-slate-400 max-w-2xl">
              Aqui você cadastra os artigos da trilha de comissário de voo,
              com imagem de capa, tipo de conteúdo (como no menu da página) e o texto completo.
              Tudo é salvo em uma <span class="font-semibold text-slate-200">tabela exclusiva</span>.
            </p>
          </section>

          <div class="grid lg:grid-cols-[minmax(0,1.2fr)_minmax(0,1fr)] gap-8 items-start">
            <!-- COLUNA ESQUERDA – FORM ARTIGO COMISSÁRIO -->
            <section class="bg-slate-950/70 border border-slate-800/70 rounded-2xl p-6 sm:p-7 shadow-xl shadow-slate-950/40">
              <h2 class="text-lg font-semibold text-slate-50 mb-4 flex items-center gap-2">
                <span class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-indigo-600/20 text-indigo-300 border border-indigo-500/40 text-sm">
                  1
                </span>
                Novo conteúdo do comissário
              </h2>

              <form id="cms-form" class="space-y-6">
                <!-- IMAGEM DE CAPA -->
                <div>
                  <label class="block text-sm font-medium text-slate-200 mb-1">
                    Imagem de capa
                  </label>
                  <div
                    id="cms-cover-dropzone"
                    class="mt-1 flex flex-col items-center justify-center rounded-xl border border-dashed border-slate-700 bg-slate-900/40 px-4 py-5 text-center cursor-pointer transition"
                  >
                    <input
                      type="file"
                      id="cms-cover-file"
                      accept="image/*"
                      class="hidden"
                    >
                    <div class="flex flex-col items-center gap-2">
                      <div class="flex h-10 w-10 items-center justify-center rounded-full bg-slate-800 text-indigo-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6"
                                d="M4 5h16v14H4zM8 11l2.5 3L13 11l3 4"/>
                          <circle cx="9" cy="9" r="1.2" />
                        </svg>
                      </div>
                      <p class="text-sm text-slate-200">
                        Arraste a capa ou clique para selecionar
                      </p>
                      <p class="text-xs text-slate-500">
                        JPG, PNG ou WEBP – tamanho moderado
                      </p>
                      <p id="cms-cover-name" class="text-xs text-indigo-300 mt-1 hidden"></p>
                    </div>
                  </div>
                </div>

                <!-- SELETOR DE TIPO (MENU) -->
                <div>
                  <label class="block text-sm font-medium text-slate-200 mb-2">
                    Tipo de conteúdo (menu)
                  </label>

                  <!-- Botões tipo "pílula" como na imagem -->
                  <div id="cms-menu-buttons" class="inline-flex flex-wrap gap-2 bg-slate-950/80 border border-slate-800 rounded-2xl p-2">
                    <button type="button" data-value="antes" class="cms-menu-btn px-4 py-2 rounded-xl text-xs sm:text-sm bg-indigo-600 text-white font-medium shadow shadow-indigo-900/40">
                      O que saber antes de qualquer coisa?
                    </button>
                    <button type="button" data-value="certificacao" class="cms-menu-btn px-4 py-2 rounded-xl text-xs sm:text-sm bg-slate-900 text-slate-200 border border-slate-700 hover:border-indigo-500 hover:text-indigo-200">
                      O que estudar para a certificação?
                    </button>
                    <button type="button" data-value="depois" class="cms-menu-btn px-4 py-2 rounded-xl text-xs sm:text-sm bg-slate-900 text-slate-200 border border-slate-700 hover:border-indigo-500 hover:text-indigo-200">
                      O que saber depois da certificação?
                    </button>
                    <button type="button" data-value="entrevista" class="cms-menu-btn px-4 py-2 rounded-xl text-xs sm:text-sm bg-slate-900 text-slate-200 border border-slate-700 hover:border-indigo-500 hover:text-indigo-200">
                      Como passar na entrevista?
                    </button>
                  </div>

                  <input type="hidden" id="cms-menu-type" value="antes">
                </div>

                <!-- TÍTULO DO ARTIGO -->
                <div>
                  <label for="cms-title" class="block text-sm font-medium text-slate-200 mb-1">
                    Título do artigo
                  </label>
                  <input
                    type="text"
                    id="cms-title"
                    class="mt-1 block w-full rounded-lg border border-slate-700 bg-slate-900/60 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/60 outline-none"
                    placeholder="Ex.: 7 verdades que ninguém te conta sobre ser comissário(a)"
                    required
                  >
                </div>

                <!-- TEXTO DO ARTIGO -->
                <div>
                  <label for="cms-body" class="block text-sm font-medium text-slate-200 mb-1">
                    Texto do artigo
                  </label>
                  <textarea
                    id="cms-body"
                    rows="8"
                    class="mt-1 block w-full rounded-lg border border-slate-700 bg-slate-900/60 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/60 outline-none resize-y"
                    placeholder="Escreva aqui o conteúdo completo que será exibido na página da trilha..."
                    required
                  ></textarea>
                </div>

                <!-- BOTÃO & STATUS -->
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                  <button
                    type="submit"
                    id="cms-btn-save"
                    class="inline-flex items-center justify-center gap-2 rounded-lg bg-indigo-600 px-4 py-2.5 text-sm font-semibold text-white shadow-lg shadow-indigo-900/40 hover:bg-indigo-500 disabled:opacity-60 disabled:cursor-not-allowed transition"
                  >
                    <span id="cms-btn-save-label">Salvar conteúdo</span>
                    <svg id="cms-btn-save-spinner" class="h-4 w-4 animate-spin hidden" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3"></circle>
                      <path class="opacity-75" fill="currentColor"
                            d="M4 12a8 8 0 018-8v3a5 5 0 00-5 5H4z"></path>
                    </svg>
                  </button>

                  <p id="cms-status" class="text-xs text-slate-400 sm:text-right min-h-[1.25rem]">
                    <!-- status aqui -->
                  </p>
                </div>
              </form>
            </section>

            <!-- COLUNA DIREITA – LISTA DE ARTIGOS -->
            <section class="bg-slate-950/60 border border-slate-800/70 rounded-2xl p-5 sm:p-6 shadow-xl shadow-slate-950/40">
              <div class="flex items-center justify-between gap-2 mb-4">
                <div>
                  <h2 class="text-base font-semibold text-slate-50">
                    Conteúdos cadastrados
                  </h2>
                  <p class="text-xs text-slate-500">
                    Filtrados pelo tipo de menu e do mais recente para o mais antigo.
                  </p>
                </div>
                <button
                  id="cms-btn-reload"
                  class="inline-flex items-center justify-center rounded-full border border-slate-700 bg-slate-900/70 p-2 text-slate-300 hover:bg-slate-800 hover:text-white text-xs transition"
                  title="Recarregar lista"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6"
                          d="M4 4v6h6M20 20v-6h-6M5 19A9 9 0 0119 5M19 19A9 9 0 015 5"/>
                  </svg>
                </button>
              </div>

              <div id="cms-list" class="thin-scrollbar max-h-[360px] overflow-y-auto space-y-3 text-sm">
                <p class="text-xs text-slate-500" id="cms-list-empty">
                  Nenhum conteúdo cadastrado ainda. Salve o primeiro artigo ao lado.
                </p>
              </div>
            </section>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- ========= SCRIPT ========= -->
  <script>
    // ================= SUPABASE CLIENT =================
    const SUPABASE_URL = "https://rzgdbjdxvzksbbwjwunr.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ6Z2RiamR4dnprc2Jid2p3dW5yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzODAzMTEsImV4cCI6MjA3ODk1NjMxMX0.cslxIWp5V-FhufQUZyIGi-6xD4ZfBKJKqFRgwlSnDyM";
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const MASTER_EMAIL = "master@gmail.com";

    // TXT – bucket / tabela
    const STORAGE_BUCKET_TXT = "txt-conteudos";
    const TABLE_TXT = "txt_conteudos";

    // COMISSÁRIO – bucket / tabela exclusiva
    const STORAGE_BUCKET_COMISSARIO = "conteudos-comissario";
    const TABLE_COMISSARIO = "conteudos_comissario";

    // ================= PROTEÇÃO DE ROTA =================
    (async () => {
      const { data, error } = await supabaseClient.auth.getUser();
      if (error || !data?.user || (data.user.email || "").toLowerCase() !== MASTER_EMAIL) {
        window.location.href = "../index.html";
      }
    })();

    // ================= ELEMENTOS DOM – TXT =================
    const form = document.getElementById("txt-form");
    const titleInput = document.getElementById("txt-title");
    const fileInput = document.getElementById("txt-file");
    const dropzone = document.getElementById("dropzone");
    const fileNameLabel = document.getElementById("file-name");
    const uploadStatus = document.getElementById("upload-status");
    const btnUpload = document.getElementById("btn-upload");
    const btnUploadLabel = document.getElementById("btn-upload-label");
    const btnUploadSpinner = document.getElementById("btn-upload-spinner");
    const listContainer = document.getElementById("txt-list");
    const emptyMsg = document.getElementById("txt-list-empty");
    const btnReload = document.getElementById("btn-reload");

    // MENU / VIEWS
    const btnRedacaoPrincipal = document.getElementById("btn-redacao-principal");
    const btnRedacaoComissario = document.getElementById("btn-redacao-comissario");
    const viewRedacaoPrincipal = document.getElementById("view-redacao-principal");
    const viewRedacaoComissario = document.getElementById("view-redacao-comissario");
    const viewPlaceholder = document.getElementById("view-placeholder");

    // COMISSÁRIO – elementos
    const cmsForm = document.getElementById("cms-form");
    const cmsCoverDropzone = document.getElementById("cms-cover-dropzone");
    const cmsCoverFileInput = document.getElementById("cms-cover-file");
    const cmsCoverName = document.getElementById("cms-cover-name");
    const cmsMenuButtons = document.querySelectorAll(".cms-menu-btn");
    const cmsMenuTypeInput = document.getElementById("cms-menu-type");
    const cmsTitleInput = document.getElementById("cms-title");
    const cmsBodyInput = document.getElementById("cms-body");
    const cmsBtnSave = document.getElementById("cms-btn-save");
    const cmsBtnSaveLabel = document.getElementById("cms-btn-save-label");
    const cmsBtnSaveSpinner = document.getElementById("cms-btn-save-spinner");
    const cmsStatus = document.getElementById("cms-status");
    const cmsListContainer = document.getElementById("cms-list");
    const cmsListEmpty = document.getElementById("cms-list-empty");
    const cmsBtnReload = document.getElementById("cms-btn-reload");

    let selectedFile = null;       // TXT
    let cmsCoverFile = null;       // imagem capa
    let selectedMenuType = "antes";

    // ================= FUNÇÕES AUXILIARES =================
    function setUploading(isUploading) {
      btnUpload.disabled = isUploading;
      btnUploadSpinner.classList.toggle("hidden", !isUploading);
      btnUploadLabel.textContent = isUploading ? "Salvando..." : "Salvar texto";
    }

    function setStatus(message, type = "info") {
      uploadStatus.textContent = message || "";
      uploadStatus.classList.remove("text-slate-400", "text-emerald-400", "text-rose-400");
      if (!message) return;
      if (type === "success") uploadStatus.classList.add("text-emerald-400");
      else if (type === "error") uploadStatus.classList.add("text-rose-400");
      else uploadStatus.classList.add("text-slate-400");
    }

    function cmsSetStatus(message, type = "info") {
      cmsStatus.textContent = message || "";
      cmsStatus.classList.remove("text-slate-400", "text-emerald-400", "text-rose-400");
      if (!message) return;
      if (type === "success") cmsStatus.classList.add("text-emerald-400");
      else if (type === "error") cmsStatus.classList.add("text-rose-400");
      else cmsStatus.classList.add("text-slate-400");
    }

    function cmsSetUploading(isUploading) {
      cmsBtnSave.disabled = isUploading;
      cmsBtnSaveSpinner.classList.toggle("hidden", !isUploading);
      cmsBtnSaveLabel.textContent = isUploading ? "Salvando..." : "Salvar conteúdo";
    }

    function slugify(str) {
      return str
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "")
        .slice(0, 60);
    }

    function formatDate(isoString) {
      const d = new Date(isoString);
      if (Number.isNaN(d.getTime())) return "";
      return d.toLocaleString("pt-BR", { dateStyle: "short", timeStyle: "short" });
    }

    // MENU lateral – estado ativo
    function setActiveMenu(button) {
      [btnRedacaoPrincipal, btnRedacaoComissario].forEach(btn => {
        btn.classList.remove("border-indigo-500", "bg-slate-900", "text-indigo-200");
      });
      if (button) {
        button.classList.add("border-indigo-500", "bg-slate-900", "text-indigo-200");
      }
    }

    // ================= MENU LATERAL – AÇÃO DOS BOTÕES =================
    btnRedacaoPrincipal.addEventListener("click", () => {
      viewPlaceholder.classList.add("hidden");
      viewRedacaoPrincipal.classList.remove("hidden");
      viewRedacaoComissario.classList.add("hidden");
      setActiveMenu(btnRedacaoPrincipal);
    });

    btnRedacaoComissario.addEventListener("click", () => {
      viewPlaceholder.classList.add("hidden");
      viewRedacaoComissario.classList.remove("hidden");
      viewRedacaoPrincipal.classList.add("hidden");
      setActiveMenu(btnRedacaoComissario);
    });

    // ================= DRAG & DROP – TXT =================
    function openFileDialog() {
      fileInput.click();
    }

    dropzone.addEventListener("click", openFileDialog);

    fileInput.addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      if (file) {
        selectedFile = file;
        fileNameLabel.textContent = `Arquivo selecionado: ${file.name}`;
        fileNameLabel.classList.remove("hidden");
      }
    });

    ["dragenter", "dragover"].forEach(eventName => {
      dropzone.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.add("dropzone-highlight");
      });
    });

    ["dragleave", "drop"].forEach(eventName => {
      dropzone.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.remove("dropzone-highlight");
      });
    });

    dropzone.addEventListener("drop", (e) => {
      const file = e.dataTransfer?.files?.[0];
      if (file) {
        if (!file.name.toLowerCase().endsWith(".txt")) {
          setStatus("Envie apenas arquivos .txt", "error");
          return;
        }
        selectedFile = file;
        fileNameLabel.textContent = `Arquivo selecionado: ${file.name}`;
        fileNameLabel.classList.remove("hidden");
      }
    });

    // ================= SUBMIT (UPLOAD TXT) =================
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const title = titleInput.value.trim();
      if (!title) {
        setStatus("Informe um título para o texto.", "error");
        return;
      }
      if (!selectedFile) {
        setStatus("Selecione ou arraste um arquivo .txt.", "error");
        return;
      }
      if (!selectedFile.name.toLowerCase().endsWith(".txt")) {
        setStatus("O arquivo precisa estar no formato .txt.", "error");
        return;
      }

      setUploading(true);
      setStatus("Enviando arquivo para o Supabase Storage...");

      try {
        const now = new Date();
        const datePrefix = `${now.getFullYear()}/${String(now.getMonth() + 1).padStart(2, "0")}/${String(now.getDate()).padStart(2, "0")}`;
        const ts = now.toISOString().replace(/[:.]/g, "-");
        const safeTitle = slugify(title) || "texto";
        const path = `${datePrefix}/${ts}-${safeTitle}.txt`;

        const { data: uploadData, error: uploadError } = await supabaseClient
          .storage
          .from(STORAGE_BUCKET_TXT)
          .upload(path, selectedFile, {
            upsert: false,
            cacheControl: "3600",
          });

        if (uploadError) {
          console.error(uploadError);
          throw new Error(uploadError.message || "Erro ao enviar arquivo para o Storage.");
        }

        setStatus("Arquivo enviado. Gravando registro...", "info");

        const { error: insertError } = await supabaseClient
          .from(TABLE_TXT)
          .insert({
            title,
            path: uploadData.path,
          });

        if (insertError) {
          console.error(insertError);
          throw new Error(insertError.message || "Erro ao salvar informações na tabela.");
        }

        setStatus("Texto salvo com sucesso!", "success");

        form.reset();
        selectedFile = null;
        fileNameLabel.textContent = "";
        fileNameLabel.classList.add("hidden");

        await loadTxtList();
      } catch (err) {
        console.error(err);
        setStatus(err.message || "Erro ao salvar texto.", "error");
      } finally {
        setUploading(false);
      }
    });

    // ================= LISTAGEM TXT (MAIS NOVOS PRIMEIRO) =================
    async function loadTxtList() {
      listContainer.innerHTML = "";
      emptyMsg && emptyMsg.remove?.();

      const loadingRow = document.createElement("p");
      loadingRow.className = "text-xs text-slate-500";
      loadingRow.textContent = "Carregando textos...";
      listContainer.appendChild(loadingRow);

      const { data, error } = await supabaseClient
        .from(TABLE_TXT)
        .select("*")
        .order("created_at", { ascending: false });

      listContainer.innerHTML = "";

      if (error) {
        console.error(error);
        const errEl = document.createElement("p");
        errEl.className = "text-xs text-rose-400";
        errEl.textContent = "Erro ao carregar lista de textos.";
        listContainer.appendChild(errEl);
        return;
      }

      if (!data || data.length === 0) {
        const empty = document.createElement("p");
        empty.className = "text-xs text-slate-500";
        empty.textContent = "Nenhum texto enviado ainda.";
        listContainer.appendChild(empty);
        return;
      }

      data.forEach((row) => {
        const item = document.createElement("div");
        item.className = "flex items-start justify-between gap-3 rounded-lg border border-slate-800/80 bg-slate-900/60 px-3 py-2.5";

        const textWrap = document.createElement("div");
        textWrap.className = "flex-1 min-w-0";

        const titleEl = document.createElement("p");
        titleEl.className = "text-sm font-medium text-slate-50 truncate";
        titleEl.textContent = row.title || "(Sem título)";

        const metaEl = document.createElement("p");
        metaEl.className = "text-[11px] text-slate-400 mt-0.5";
        metaEl.textContent = formatDate(row.created_at) || "";

        textWrap.appendChild(titleEl);
        textWrap.appendChild(metaEl);

        const actions = document.createElement("div");
        actions.className = "flex items-center gap-1";

        const openBtn = document.createElement("a");
        openBtn.className = "inline-flex items-center justify-center rounded-full border border-slate-700 bg-slate-900/80 px-2.5 py-1 text-[11px] text-slate-200 hover:bg-slate-800 hover:text-white transition";
        openBtn.textContent = "Abrir";

        const publicUrl = supabaseClient
          .storage
          .from(STORAGE_BUCKET_TXT)
          .getPublicUrl(row.path).data.publicUrl;

        openBtn.href = publicUrl;
        openBtn.target = "_blank";
        openBtn.rel = "noreferrer";

        actions.appendChild(openBtn);

        item.appendChild(textWrap);
        item.appendChild(actions);

        listContainer.appendChild(item);
      });
    }

    btnReload.addEventListener("click", loadTxtList);

    // ================= COMISSÁRIO – COVER DRAG & DROP =================
    cmsCoverDropzone.addEventListener("click", () => {
      cmsCoverFileInput.click();
    });

    cmsCoverFileInput.addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      if (file) {
        cmsCoverFile = file;
        cmsCoverName.textContent = `Arquivo selecionado: ${file.name}`;
        cmsCoverName.classList.remove("hidden");
      }
    });

    ["dragenter", "dragover"].forEach(eventName => {
      cmsCoverDropzone.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
        cmsCoverDropzone.classList.add("dropzone-highlight");
      });
    });

    ["dragleave", "drop"].forEach(eventName => {
      cmsCoverDropzone.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
        cmsCoverDropzone.classList.remove("dropzone-highlight");
      });
    });

    cmsCoverDropzone.addEventListener("drop", (e) => {
      const file = e.dataTransfer?.files?.[0];
      if (file) {
        if (!file.type.startsWith("image/")) {
          cmsSetStatus("Envie apenas imagens (JPG, PNG, WEBP).", "error");
          return;
        }
        cmsCoverFile = file;
        cmsCoverName.textContent = `Arquivo selecionado: ${file.name}`;
        cmsCoverName.classList.remove("hidden");
      }
    });

    // ================= COMISSÁRIO – SELETOR DE MENU =================
    cmsMenuButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const value = btn.getAttribute("data-value") || "antes";
        selectedMenuType = value;
        cmsMenuTypeInput.value = value;

        cmsMenuButtons.forEach(b => {
          b.classList.remove("bg-indigo-600", "text-white", "shadow", "shadow-indigo-900/40");
          b.classList.remove("border-indigo-500", "text-indigo-200");
          if (!b.classList.contains("bg-slate-900")) {
            b.classList.add("bg-slate-900");
          }
        });

        btn.classList.add("bg-indigo-600", "text-white", "shadow", "shadow-indigo-900/40");
      });
    });

    // ================= COMISSÁRIO – SUBMIT =================
    cmsForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const title = cmsTitleInput.value.trim();
      const body = cmsBodyInput.value.trim();
      const menuType = selectedMenuType;

      if (!cmsCoverFile) {
        cmsSetStatus("Selecione uma imagem de capa.", "error");
        return;
      }
      if (!title) {
        cmsSetStatus("Informe o título do artigo.", "error");
        return;
      }
      if (!body) {
        cmsSetStatus("Escreva o texto do artigo.", "error");
        return;
      }

      cmsSetUploading(true);
      cmsSetStatus("Enviando capa e salvando conteúdo...");

      try {
        const now = new Date();
        const datePrefix = `${now.getFullYear()}/${String(now.getMonth() + 1).padStart(2, "0")}/${String(now.getDate()).padStart(2, "0")}`;
        const ts = now.toISOString().replace(/[:.]/g, "-");
        const safeTitle = slugify(title) || "artigo";
        const ext = (cmsCoverFile.name.split(".").pop() || "jpg").toLowerCase();
        const path = `covers/${datePrefix}/${ts}-${safeTitle}.${ext}`;

        const { data: uploadData, error: uploadError } = await supabaseClient
          .storage
          .from(STORAGE_BUCKET_COMISSARIO)
          .upload(path, cmsCoverFile, {
            upsert: false,
            cacheControl: "3600",
          });

        if (uploadError) {
          console.error(uploadError);
          throw new Error(uploadError.message || "Erro ao enviar capa para o Storage.");
        }

        const { error: insertError } = await supabaseClient
          .from(TABLE_COMISSARIO)
          .insert({
            menu_type: menuType,
            title,
            body,
            cover_path: uploadData.path,
          });

        if (insertError) {
          console.error(insertError);
          throw new Error(insertError.message || "Erro ao salvar conteúdo na tabela exclusiva.");
        }

        cmsSetStatus("Conteúdo salvo com sucesso!", "success");

        cmsForm.reset();
        cmsCoverFile = null;
        cmsCoverName.textContent = "";
        cmsCoverName.classList.add("hidden");

        // volta seletor para o primeiro
        selectedMenuType = "antes";
        cmsMenuTypeInput.value = "antes";

        cmsMenuButtons.forEach((b, idx) => {
          b.classList.remove("bg-indigo-600", "text-white", "shadow", "shadow-indigo-900/40");
          if (idx === 0) {
            b.classList.add("bg-indigo-600", "text-white", "shadow", "shadow-indigo-900/40");
          } else {
            b.classList.add("bg-slate-900");
          }
        });

        await loadComissarioList();
      } catch (err) {
        console.error(err);
        cmsSetStatus(err.message || "Erro ao salvar conteúdo.", "error");
      } finally {
        cmsSetUploading(false);
      }
    });

    // ================= COMISSÁRIO – LISTAGEM =================
    async function loadComissarioList() {
      cmsListContainer.innerHTML = "";
      cmsListEmpty && cmsListEmpty.remove?.();

      const loadingRow = document.createElement("p");
      loadingRow.className = "text-xs text-slate-500";
      loadingRow.textContent = "Carregando conteúdos...";
      cmsListContainer.appendChild(loadingRow);

      const { data, error } = await supabaseClient
        .from(TABLE_COMISSARIO)
        .select("*")
        .order("created_at", { ascending: false });

      cmsListContainer.innerHTML = "";

      if (error) {
        console.error(error);
        const errEl = document.createElement("p");
        errEl.className = "text-xs text-rose-400";
        errEl.textContent = "Erro ao carregar lista de conteúdos.";
        cmsListContainer.appendChild(errEl);
        return;
      }

      if (!data || data.length === 0) {
        const empty = document.createElement("p");
        empty.className = "text-xs text-slate-500";
        empty.textContent = "Nenhum conteúdo cadastrado ainda.";
        cmsListContainer.appendChild(empty);
        return;
      }

      const menuLabels = {
        "antes": "O que saber antes de qualquer coisa?",
        "certificacao": "O que estudar para a certificação?",
        "depois": "O que saber depois da certificação?",
        "entrevista": "Como passar na entrevista?"
      };

      data.forEach((row) => {
        const item = document.createElement("div");
        item.className = "flex items-start justify-between gap-3 rounded-lg border border-slate-800/80 bg-slate-900/60 px-3 py-2.5";

        const textWrap = document.createElement("div");
        textWrap.className = "flex-1 min-w-0";

        const label = document.createElement("span");
        label.className = "inline-flex items-center rounded-full bg-slate-800 text-[10px] text-indigo-300 px-2 py-0.5 mb-1 border border-indigo-500/30";
        label.textContent = menuLabels[row.menu_type] || row.menu_type || "Sem categoria";

        const titleEl = document.createElement("p");
        titleEl.className = "text-sm font-medium text-slate-50 truncate";
        titleEl.textContent = row.title || "(Sem título)";

        const metaEl = document.createElement("p");
        metaEl.className = "text-[11px] text-slate-400 mt-0.5";
        metaEl.textContent = formatDate(row.created_at) || "";

        textWrap.appendChild(label);
        textWrap.appendChild(titleEl);
        textWrap.appendChild(metaEl);

        const actions = document.createElement("div");
        actions.className = "flex flex-col items-end gap-1";

        // botão para abrir capa (URL pública)
        if (row.cover_path) {
          const publicUrl = supabaseClient
            .storage
            .from(STORAGE_BUCKET_COMISSARIO)
            .getPublicUrl(row.cover_path).data.publicUrl;

          const openCoverBtn = document.createElement("a");
          openCoverBtn.className = "inline-flex items-center justify-center rounded-full border border-slate-700 bg-slate-900/80 px-2.5 py-1 text-[11px] text-slate-200 hover:bg-slate-800 hover:text-white transition";
          openCoverBtn.textContent = "Ver capa";
          openCoverBtn.href = publicUrl;
          openCoverBtn.target = "_blank";
          openCoverBtn.rel = "noreferrer";
          actions.appendChild(openCoverBtn);
        }

        item.appendChild(textWrap);
        item.appendChild(actions);

        cmsListContainer.appendChild(item);
      });
    }

    cmsBtnReload.addEventListener("click", loadComissarioList);

    // Carrega listas ao abrir a página
    loadTxtList();
    loadComissarioList();
  </script>
</body>
</html>
